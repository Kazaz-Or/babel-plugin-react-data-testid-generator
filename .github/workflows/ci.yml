name: ðŸ” PR Validations

on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22.16.0"

jobs:
  check-ready:
    name: ðŸš¦ Check PR Status
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
    steps:
      - name: ðŸš¦ Check if PR is ready
        id: check
        run: |
          if [[ "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "ðŸš§ PR is in draft mode, skipping validation"
          else
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "âœ… PR is ready for validation"
          fi

  checks:
    name: Checks
    runs-on: ubuntu-latest
    needs: check-ready
    if: needs.check-ready.outputs.ready == 'true'
    strategy:
      matrix:
        check: [lint, typecheck, format-check, test, build]

    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: ðŸ“¦ Install Dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸ” Run Lint
        if: matrix.check == 'lint'
        run: yarn lint

      - name: ðŸ“ Run Type Check
        if: matrix.check == 'typecheck'
        run: yarn tsc --noEmit

      - name: ðŸŽ¨ Check Code Formatting
        if: matrix.check == 'format-check'
        run: yarn fmt:check

      - name: ðŸ§ª Run Tests with Coverage
        if: matrix.check == 'test'
        run: yarn test:coverage

      - name: ðŸ—ï¸ Run Build
        if: matrix.check == 'build'
        run: yarn build

  summary:
    name: ðŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [check-ready, checks]
    if: always() && needs.check-ready.outputs.ready == 'true'

    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "## ðŸŽ¯ PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # All checks results
          echo "### âš¡ Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| All Checks (Lint, TypeCheck, Format, Test + Coverage, Build) | ${{ needs.checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.checks.result }}" == "success" ]]; then
            echo "### âœ… All Checks Passed!" >> $GITHUB_STEP_SUMMARY
            echo "Your babel plugin is ready for merge! ðŸš€" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Code style and formatting" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… TypeScript compilation" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… All tests passing with coverage â‰¥80%" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Snapshot tests match expected output" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed checks above and fix any issues." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note**: If tests fail due to snapshots, run \`yarn test -- --updateSnapshot\` locally if the changes are intentional." >> $GITHUB_STEP_SUMMARY
          fi
